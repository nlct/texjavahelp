\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{texjavahelp}[2024/03/16 v0.1a (NLCT)]

\RequirePackage{fontawesome}

\PassOptionsToPackage{breakable,skins,listings}{tcolorbox}
\RequirePackage{tcolorbox}

\PassOptionsToPackage{hidelinks}{hyperref}
\RequirePackage{hyperref}

\PassOptionsToPackage{
 record=nameref,
 indexcounter,
 floats,
 nostyles,
 stylemods={tree,bookindex,topic},
 style=alttree
}{glossaries-extra}

\RequirePackage{glossaries-extra}

\appto\glsxtrresourceinit{\GlsXtrResourceInitEscSequences}

\glsaddkey{shortswitch}{}{\shortswitchvalue}{\Shortswitchvalue}{\shortswitch}{\Shortswitch}{\SHORTSWITCH}

\glsaddstoragekey{defaultkeys}{}{\defaultkeys}
\glsaddstoragekey{syntax}{}{\syntax}
  
\renewcommand{\glslinkpresetkeys}{%
 \glsxtrifhasfield*{defaultkeys}{\glslabel}
 {\expandafter\setupglslink\expandafter{\glscurrentfieldvalue}}%
 {}%
} 

\setabbreviationstyle[commonabbreviation]{short-nolong}

\newcommand{\TeXJavaHelpGlsFieldAdjustments}{
 description-case-change=firstuc,
 post-description-dot=check
}

\newcommand{\TeXJavaHelpGlsResourceOptions}{
  \TeXJavaHelpGlsFieldAdjustments,
  entry-type-aliases=
   {
     application=index,
     file=index,
     package=index,
     class=index,
     option=index,
     switch=index,
     term=entry,
     commonabbreviation=abbreviation
   },
  category = same as original entry,
  assign-fields=
   {
      name = "\cs{appfmt}{" + entrylabel->original + "}"
        [ entrytype->original = "application"], 
      name = "\cs{filefmt}{" + entrylabel->original + "}"
        [ entrytype->original = "file"], 
      name = "\cs{styfmt}{" + entrylabel->original + "}"
        [ entrytype->original = "package"], 
      name = "\cs{clsfmt}{" + entrylabel->original + "}"
        [ entrytype->original = "class"], 
      name = "\cs{optfmt}{" + entrylabel->original + "}"
        [ entrytype->original = "option"], 
      name = "\cs{longswitchfmt}{" + entrylabel->original + "}"
        [ entrytype->original = "switch"], 
      shortswitch =[o] "\cs{shortswitchfmt}{" + shortswitch + "}"
        [ entrytype->original = "switch" & shortswitch <> \NULL], 
      defaultkeys = "format=glsignore"
        [ entrytype->original = /common/ ]
   },
   save-child-count,
}

\newcommand{\appfmt}[1]{\texttt{#1}}
\MFUblocker{\appfmt}

\newcommand{\filefmt}[1]{\texttt{#1}}
\MFUblocker{\filefmt}

\newcommand{\styfmt}[1]{\texttt{#1}}
\MFUblocker{\styfmt}

\newcommand{\clsfmt}[1]{\texttt{#1}}
\MFUblocker{\clsfmt}

\newcommand{\optfmt}[1]{\texttt{#1}}
\MFUblocker{\optfmt}

\newcommand{\longswitchfmt}[1]{\texttt{-\/-#1}}
\MFUblocker{\longswitchfmt}

\newcommand{\shortswitchfmt}[1]{\texttt{-#1}}
\MFUblocker{\shortswitchfmt}

\ifdef\GlsXtrSetPlusModifier
{\GlsXtrSetPlusModifier{format=glsnumberformat}}{}

\ifdef\GlsXtrSetAltModifier
{\GlsXtrSetAltModifier{!}{format=glsignore}}{}

\newcommand{\cs}[1]{\texttt{\glsbackslash #1}}

\newrobustcmd*{\texmeta}[1]{{\normalfont$\langle$\emph{#1}$\rangle$}}

\newcommand*{\meta}[1]{%
 \texorpdfstring{\ifmmode\text{\texmeta{#1}}\else\texmeta{#1}\fi}{\string<#1\string>}%
}

\newcommand*{\oarg}[1]{\discretionary{}{}{}[#1]}
\newcommand*{\oargm}[1]{\oarg{\meta{#1}}}

% To prevent lonely [ and ] from upsetting the syntax highlighter:
\newrobustcmd*{\nlctopensqbracket}{[}
\newrobustcmd*{\nlctclosesqbracket}{]}

% To prevent lonely ( and ) from upsetting the syntax highlighter:
\newrobustcmd*{\nlctopenparen}{(}
\newrobustcmd*{\nlctcloseparen}{)}

\newcommand*{\marg}[1]{\texorpdfstring
 {\discretionary{}{}{}\char`\{#1\char`\} \discretionary{}{}{}}%
 {\{#1\}}%
}

\newcommand*{\margm}[1]{\marg{\meta{#1}}}

\providecommand{\glsxtrtargetorlink}[2]{%
 \GlsXtrIfFieldUndef{\glsxtrtargetfield}{#1}% 
 {%
   \@glstarget{\glolinkprefix #1}{#2}%
   \xGlsXtrSetField{#1}{\glsxtrtargetfield}{\glolinkprefix #1}%
 }{\hyperlink{\glsxtrusefield{#1}{\glsxtrtargetfield}}{#2}}%
}

\renewcommand{\glstarget}{\glsxtrtargetorlink}

\newcommand{\postclihook}{%
 \glsxtrifhasfield{syntax}{\glscurrententrylabel}%
  {\space\glscurrentfieldvalue}{}%
}

\NewDocumentCommand\clidef{O{}m}{%
 \begin{terminal}[#1]%
 \let\glsxtrpostnameapplication\postclihook
 \glsxtrglossentry{#2}%
 \end{terminal}% 
}

\newcommand{\postswitchhook}{%
 \glsxtrifhasfield{syntax}{\glscurrententrylabel}%
  {\space\glscurrentfieldvalue}{}%
 \glsxtrifhasfield{shortswitch}{\glscurrententrylabel}%
  {\space\textnormal{(or \glscurrentfieldvalue)}}{}%
}

\NewDocumentCommand\switchdef{O{}m}{%
 \begin{plaincodebox}[#1]%
 \let\glsxtrpostnameswitch\postswitchhook
 \glsxtrglossentry{#2}%
 \end{plaincodebox}% 
}

\NewDocumentCommand\stydef{O{}m}{%
 \begin{codebox}[#1]%
 \cs{usepackage}%
 \glsxtrifhasfield{syntax}{#2}{\oarg{\glscurrentfieldvalue}}{}%
 \marg{\glsxtrglossentry{#2}}%
 \end{codebox}% 
}

\NewDocumentCommand\clsdef{O{}m}{%
 \begin{codebox}[#1]%
 \cs{documentclass}%
 \glsxtrifhasfield{syntax}{#2}{\oarg{\glscurrentfieldvalue}}{}%
 \marg{\glsxtrglossentry{#2}}%
 \end{codebox}% 
}

\newcommand{\postoptionhook}{%
 \glsxtrifhasfield{syntax}{\glscurrententrylabel}{=\glscurrentfieldvalue}{}%
}

\NewDocumentCommand\optiondef{O{}m}{%
 \begin{plaincodebox}[#1]%
 \let\glsxtrpostnameoption\postoptionhook
 \glsxtrglossentry{#2}%
 \end{plaincodebox}% 
}

\newignoredglossary{minilist}

\ExplSyntaxOn

\NewDocumentCommand \listentry { O{} m }
{
 \group_begin:
   \__texjavahelp_hier_copy:ne { minilist } { #2 }
   \cs_set_eq:NN \glsxtrpostnameapplication \postclihook
   \cs_set_eq:NN \glsxtrpostnameswitch \postswitchhook
   \cs_set_eq:NN \glsxtrpostnameoption \postoptionhook
   \cs_set_eq:NN \glstopicSubItemBox \use_ii:nn
   \printunsrtglossary 
   [
      type=minilist,
      style=topic,
      title = { \glsfmttext{#2} ~ Summary},
      nonumberlist,
      leveloffset = { - \glsxtrusefield { #2 } { level } } ,
      #1
   ]
 \group_end:
}

\NewDocumentCommand \listentrydescendents { O{} m }
{
 \group_begin:
  \glsxtrifhasfield* { childlist } { #2 }
  {
    \cs_set:Npn \do ##1
     {
       \__texjavahelp_hier_copy:nn { minilist } { ##1 }
     }
    \glsxtrfielddolistloop { #2 } { childlist }
  } 
  { }
   \cs_set_eq:NN \glsxtrpostnameapplication \postclihook
   \cs_set_eq:NN \glsxtrpostnameswitch \postswitchhook
   \cs_set_eq:NN \glsxtrpostnameoption \postoptionhook
   \cs_set_eq:NN \glstopicSubItemBox \use_ii:nn
   \printunsrtglossary 
   [
      type=minilist,
      style=topic,
      title = { \glsfmttext{#2} ~ Summary},
      nonumberlist,
      leveloffset = { \int_eval:n { - \glsxtrusefield { #2 } { level } - 1 } } ,
      #1
   ]
 \group_end:
}

\cs_new:Nn \__texjavahelp_hier_copy:nn
{
  \glsxtrcopytoglossary { #2 } { #1 }
  \glsxtrifhasfield* { childlist } { #2 }
  {
    \cs_set:Npn \do ##1
     {
       \__texjavahelp_hier_copy:nn { #1 } { ##1 }
     }
    \glsxtrfielddolistloop { #2 } { childlist }
  } 
  { }
}
\cs_generate_variant:Nn \__texjavahelp_hier_copy:nn { ne }

\dim_new:N \l__texjavahelp_width_dim

\cs_new:Nn \__texjavahelp_update_widest:n
{
  \glsmeasurewidth \l__texjavahelp_width_dim
    { \glstreenamefmt { \glossentryname { #1 } } \quad } 
  \dim_compare:nNnT { \l__texjavahelp_width_dim } > { \glsxtrtreetopindent }
   {
     \dim_set_eq:NN \glsxtrtreetopindent  \l__texjavahelp_width_dim 
   }
}

\newcommand{\ifterm}[3]{%
 \glsifcategory{#1}{abbreviation}{#2}%
 {\glsifcategory{#1}{term}{#2}{#3}}%
}

\newcommand{\filterterms}[1]{%
  \ifterm{#1}{}{\printunsrtglossaryskipentry}%
}

\newcommand{\filtermeasureterms}[1]{%
  \ifterm { #1 }
  { \__texjavahelp_update_widest:n { #1 } }
  { \printunsrtglossaryskipentry }
}

\newcommand{\printtermsinit}{
  \dim_zero:N \glsxtrtreetopindent
  \renewcommand{\glsxtralttreeInit}{\glsxtrAltTreeIndent=\parindent}
  \let\printunsrtglossaryentryprocesshook\filtermeasureterms
}

% This command prints a list of terms but is set up for childless entries
\NewDocumentCommand \printterms { O{} }
{
  \group_begin:
    \printtermsinit
    \printunsrtglossary[nogroupskip,nonumberlist,style=alttree,#1]%
  \group_end:
}

\ExplSyntaxOff

\NewDocumentCommand\printindex{O{}}{%
  {%
    \let\glsxtrpostnameabbreviation\abbrpostindexnamehook
    \let\glsxtrpostnamepackage\packagenamehook
    \let\glsxtrpostnameclass\classnamehook
    \printunsrtglossary[style=bookindex,title=\indexname]%
  }%
}

\newcommand{\abbrpostindexnamehook}{%
  \ifglshaslong\glscurrententrylabel
  {\space (\glsfmtlong{\glscurrententrylabel})}%
  {}%
}

\newcommand{\packagenamehook}[1]{\space package}
\newcommand{\classnamehook}[1]{\space class}

% tcolorbox Boxes

\newlength\boxtitleshift
\setlength{\boxtitleshift}{-2.5mm}

\newcommand{\terminalicon}{\faTerminal}
\newcommand{\codeicon}{\faFileTextO}
\newcommand{\warningicon}{\faExclamationTriangle}
\newcommand{\importanticon}{\faInfo}
\newcommand{\informationicon}{\faInfoCircle}

\newtcolorbox{warning}[1][]{breakable,
 before upper={\parindent12pt\noindent}, 
 title={\warningicon},
 coltitle=red,colbacktitle=red!20!white,
 colframe=red,colback=red!5!white,
 enhanced,attach boxed title to top right={yshift=\boxtitleshift},#1}

\newtcolorbox{important}[1][]{breakable,title={\importanticon},
 before upper={\parindent12pt\noindent},
 coltitle=red,colbacktitle=red!20!white,
 colframe=red,colback=red!5!white,
 enhanced,attach boxed title to top right={yshift=\boxtitleshift},#1}
  
\newtcolorbox{information}[1][]{breakable,title={\informationicon},
 before upper={\parindent12pt\noindent},
 coltitle=teal,colbacktitle=teal!20!white,
 colframe=teal,colback=teal!5!white,
 enhanced,attach boxed title to top right={yshift=\boxtitleshift},#1}
  

\newcommand{\displayboxdefaultafter}{\par\noindent\ignorespacesafterend}

% NB These boxes aren't set up for verbatim

\newtcolorbox{terminal}[1][]{unbreakable,title={\terminalicon},
 colframe=black,
 enhanced,attach boxed title to top right={yshift=\boxtitleshift},
 after={\displayboxdefaultafter},
 halign=flush left,fontupper=\ttfamily,before upper={\frenchspacing\obeylines},
 #1
}

\newtcolorbox{codebox}[1][]{unbreakable,title={\codeicon},
 colframe=black,
 enhanced,attach boxed title to top right={yshift=\boxtitleshift},
 after={\displayboxdefaultafter},
 halign=flush left,fontupper=\ttfamily,before upper={\frenchspacing\obeylines},
 #1
}

\newtcolorbox{plaincodebox}[1][]{unbreakable,
 after={\displayboxdefaultafter},
 halign=flush left,fontupper=\ttfamily,before upper={\frenchspacing\obeylines},
 #1
}


\endinput
